DROP PROCEDURE  IF EXISTS BILL;
DELIMITER $$

CREATE PROCEDURE BILL()
 BEGIN
 
 DECLARE done INT DEFAULT FALSE;
 DECLARE UNITS DECIMAL;
 DECLARE RATE DECIMAL;
 DECLARE AMT DECIMAL;
 DECLARE SURCHARGE DECIMAL;
 DECLARE EXCISE DECIMAL;
 DECLARE NET DECIMAL;

 DECLARE ID VARCHAR(4);
 DECLARE TP VARCHAR(1);

 DECLARE PREAD DECIMAL;
 DECLARE CREAD DECIMAL;
 DECLARE CT VARCHAR(1);
 DECLARE BL VARCHAR(1);
         
 DECLARE  BILLING CURSOR FOR SELECT * FROM CUSTOMER;
 DECLARE CONTINUE HANDLER FOR NOT FOUND SET done=TRUE;
 


   OPEN BILLING;
   READ_LOOP: LOOP
     FETCH BILLING INTO ID,TP,PREAD,CREAD,CT,BL; 
     IF DONE THEN
      LEAVE READ_LOOP;
     END IF;
     
     SET UNITS=CREAD-PREAD;
      IF CT='A' THEN
       SET RATE=1;
     ELSEIF CT='I' THEN
        SET RATE=1.25;
     ELSEIF CT='C' THEN
        SET RATE=1.50;
     ELSE
        SET RATE=1.30;
   
     END IF;
     
       SET AMT = RATE*UNITS;
      
      IF TP='S' THEN
        SET SURCHARGE= 0.05*AMT;
      ELSE
        SET SURCHARGE= 0.10*AMT;
      END IF;

      SET EXCISE = 0.30 * (AMT+SURCHARGE);
      SET NET = AMT+SURCHARGE+EXCISE;

    INSERT INTO T1 VALUES(UNITS,RATE,AMT,SURCHARGE,EXCISE,NET);
  
   END LOOP;
    
   CLOSE BILLING;  

  DROP TABLE IF EXISTS T2;
  CREATE TABLE T2  SELECT AMT,SURCHARGE,EXCISE,NET FROM T1; 
         
 END;
 $$

DELIMITER ;
